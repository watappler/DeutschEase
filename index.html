<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Adjektivdeklination Trainer</title>
<style>
  :root{--bg:#f8fafc;--card:#ffffff;--ink:#0f172a;--muted:#475569;--ring:#e2e8f0;--accent:#2563eb}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#f8fafc,#fff);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP",sans-serif;color:var(--ink)}
  .wrap{max-width:980px;margin:20px auto;padding:0 16px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .card{background:var(--card);border:1px solid var(--ring);border-radius:16px;box-shadow:0 1px 2px rgba(2,6,23,.05);padding:16px}
  h1{font-size:20px;margin:0 0 6px}
  .subtitle{color:var(--muted);font-size:13px;margin-bottom:14px}
  .seg{display:inline-flex;border:1px solid var(--ring);border-radius:10px;overflow:hidden}
  .seg button{border:0;background:#fff;padding:8px 12px;color:var(--muted);cursor:pointer}
  .seg button.active{background:var(--accent);color:#fff}
  .seg button:not(.active):hover{background:#f1f5f9}
  .question{font-size:22px;line-height:1.45;display:block;min-height:2.6em;position:relative;z-index:2}
  .blank{display:inline-block;min-width:4.5ch;border:2px dotted #94a3b8;border-radius:6px;padding:0 8px;margin:0 2px;line-height:1.2;background:#fff}
  .ja{color:var(--muted);font-size:15px;margin-top:6px}
  .choices{display:flex;gap:10px;margin-top:14px;flex-wrap:nowrap;overflow:hidden;align-items:stretch;transform-origin:left center;will-change:transform;position:relative;z-index:1}
  .choices button{border:1px solid var(--ring);border-radius:12px;padding:0 12px;font-size:18px;background:#fff;cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:clip;line-height:1;height:52px;flex:1 1 0;display:flex;align-items:center;justify-content:center;min-width:0;transition:background-color .15s ease,border-color .15s ease,color .15s ease}
  .choices button:hover{background:#f8fafc;border-color:#cbd5e1}
  .choices button.correct{background:#d1fae5;border-color:#34d399;color:#065f46}
  .choices button.wrong{background:#ffe4e6;border-color:#fb7185;color:#9f1239}
  .meta{display:flex;gap:12px;flex-wrap:wrap;color:var(--muted);font-size:12px;margin-top:8px}
  .explain{margin-top:14px;padding:12px;border:1px dashed var(--ring);border-radius:12px;background:#fafafa}
  .result-full{margin-bottom:16px}
  .explain h3{margin:0 0 6px;font-size:16px}
  .explain .cols{display:grid;grid-template-columns:1fr max-content;column-gap:8px;align-items:stretch}
  .explain .cols .left{margin-top:0;display:flex;flex-direction:column}
  .explain .right{width:auto;display:flex;flex-direction:column;justify-content:flex-start;gap:4px;align-items:center;text-align:center;height:100%}
  .explain .right h3{text-align:center}
  .explain .right .sub-de{font-size:12px;color:var(--muted);margin:2px 0 4px}
  .explain .left .de{font-size:13px;color:#334155;margin-top:4px}
  .caseList{border:1px solid var(--ring);border-radius:8px;padding:4px;background:#fff;margin:2px auto 0;display:inline-block;text-align:left}
  .caseList .case{display:grid;grid-template-columns:minmax(0,1fr) 3em;align-items:center;column-gap:16px;border-bottom:1px dashed var(--ring);padding:2px 0}
  .caseList .case:last-child{border-bottom:0}
  .case .label{font-size:12px;color:var(--muted);line-height:1.1;text-align:left}
  .case .ending{font-weight:700;letter-spacing:.2px;white-space:nowrap;text-align:left;width:3em;font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
  .footer{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  .btn{border:1px solid var(--ring);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .btn.tiny{padding:4px 8px;font-size:12px}
  .stat{margin-left:auto;color:var(--muted);font-size:12px}
  details.ref{border:1px dashed var(--ring);border-radius:12px;padding:10px;background:#fbfbff}
  details.ref>summary{list-style:none;cursor:pointer;font-weight:600;color:#1e3a8a}
  details.ref>summary::-webkit-details-marker{display:none}
  .ref-note{color:var(--muted);font-size:12px;margin-top:6px}
  .ref-tabs{display:flex;gap:6px;flex-wrap:wrap;margin:10px 0}
  .ref-tabs button{border:1px solid var(--ring);background:#fff;border-radius:999px;padding:6px 10px;font-size:12px;color:#334155;cursor:pointer}
  .ref-tabs button.active{background:#2577eb;border-color:#2577eb;color:#fff}
  .gender-tabs{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0}
  .gender-tabs button{border:1px solid var(--ring);background:#fff;border-radius:8px;padding:6px 10px;font-size:12px;color:#334155;cursor:pointer}
  .gender-tabs button.active{background:#0ea5e9;border-color:#0ea5e9;color:#fff}
  .checks{display:flex;gap:8px;flex-wrap:wrap}
  #caseChecks{flex-wrap:nowrap;gap:6px}
  #caseChecks .chk{white-space:nowrap}
  .chk{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--ring);background:#fff;border-radius:999px;padding:6px 10px;font-size:12px;color:#334155}
  .chk input{accent-color:var(--accent)}
  .example{border:1px dashed var(--ring);border-radius:10px;padding:10px;background:#fff;margin-top:8px}
  .example h4{margin:0 0 6px;font-size:14px;color:#334155}
  table.ex-table{display:inline-table;width:auto;border-collapse:separate;border-spacing:0;margin-top:6px;table-layout:fixed;font-size:14px}
  table.ex-table th,table.ex-table td{border:1px solid var(--ring);padding:6px 8px;text-align:left;white-space:nowrap}
  .end{font-weight:700;padding:0 2px;border-radius:4px}
  .end.e{background:#fecdd3}
  .end.en{background:#e5e7eb}
  .end.em{background:#e0f2fe}
  .end.er{background:#ede9fe}
  .end.es{background:#fef3c7}
  table.ref-table{width:100%;border-collapse:separate;border-spacing:0;margin-top:8px}
  table.ref-table th,table.ref-table td{border:1px solid var(--ring);padding:8px 10px;text-align:center}
  table.ref-table th{background:#f1f5f9}
  .ref-table td.en-bg{background:#f3f4f6}
  .ref-table.hl-masculine th:nth-child(2){background:#eef2ff;color:#3730a3;box-shadow:inset 0 0 0 2px #6366f1;border-color:#6366f1}
  .ref-table.hl-neuter th:nth-child(3){background:#fffbeb;color:#7c2d12;box-shadow:inset 0 0 0 2px #fbbf24;border-color:#fbbf24}
  .ref-table.hl-feminine th:nth-child(4){background:#fff1f2;color:#9f1239;box-shadow:inset 0 0 0 2px #fb7185;border-color:#fb7185}
  .ref-table.hl-plural th:nth-child(5){background:#f5f3ff;color:#4c1d95;box-shadow:inset 0 0 0 2px #8b5cf6;border-color:#8b5cf6}
  .ref-table.hl-masculine th.flash, .ref-table.hl-masculine td.flash{animation:flashIndigo .85s ease-out 1}
  .ref-table.hl-neuter th.flash, .ref-table.hl-neuter td.flash{animation:flashAmber .85s ease-out 1}
  .ref-table.hl-feminine th.flash, .ref-table.hl-feminine td.flash{animation:flashRose .85s ease-out 1}
  .ref-table.hl-plural th.flash, .ref-table.hl-plural td.flash{animation:flashViolet .85s ease-out 1}
  @keyframes flashIndigo{0%{background-color:transparent}40%{background-color:#e0e7ff}100%{background-color:transparent}}
  @keyframes flashAmber{0%{background-color:transparent}40%{background-color:#fde68a}100%{background-color:transparent}}
  @keyframes flashRose{0%{background-color:transparent}40%{background-color:#fecdd3}100%{background-color:transparent}}
  @keyframes flashViolet{0%{background-color:transparent}40%{background-color:#e9d5ff}100%{background-color:transparent}}
  #tags{display:none}
  .badge{display:inline-block;padding:4px 12px;border-radius:999px;font-weight:700;font-size:14px;border:1px solid transparent}
  .badge.good{background:#dcfce7;border-color:#86efac;color:#065f46}
  .badge.bad{background:#fee2e2;border-color:#fecaca;color:#991b1b}
  .result-line{display:flex;gap:8px;align-items:center;flex-wrap:nowrap;white-space:nowrap}
  .result-line .badge{flex:0 0 auto}
  .result-line span{flex:1 1 auto;min-width:0;white-space:normal;overflow:visible;text-overflow:clip}
  .result-line code{white-space:normal}
  .hint-pill{display:inline-block;background:#eef2ff;color:#3730a3;border-radius:999px;padding:4px 10px;font-size:12px;margin-left:8px}
  .actions{margin-left:auto;display:flex;gap:8px;align-items:center}
  [hidden]{display:none!important}
  .footnotes{font-size:12px;color:var(--muted);margin-top:10px;padding-left:16px}
  .footnotes li{margin:2px 0}
  .ex-cell .ex-row{display:inline-flex;align-items:baseline;gap:6px}
  .ex-cell .ex-det{flex:0 0 var(--det-w,auto)}
  .ex-cell .ex-adj{flex:0 0 var(--adj-w,auto)}
  .ex-cell .ex-noun{flex:1 1 auto;min-width:0}
  .de-line{display:flex;gap:8px;align-items:baseline;flex-wrap:wrap}
  .decl-tag{display:inline-block;margin-left:6px;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--ring);background:#f8fafc}
  .decl-tag.weak{background:#e0f2fe;color:#075985;border-color:#bae6fd}
  .decl-tag.mixed{background:#fffbeb;color:#7c2d12;border-color:#fde68a}
  .decl-tag.strong{background:#fee2e2;color:#7f1d1d;border-color:#fecaca}
  .mix-wide{grid-column:1 / -1}
  .example .mix-title{font-size:16px;margin:0 0 6px}
  .example .mix-subtitle{font-size:13px;color:#334155;margin:-2px 0 8px}
  .choices button:disabled{opacity:1;cursor:default}
  #exampleView{display:inline-block;width:auto;max-width:100%}
  @media (max-width:480px){.ex-cell .ex-row{gap:4px}}
  .pulse{animation:pulseFlash .9s ease-out 1}
  @keyframes pulseFlash{0%{box-shadow:0 0 0 0 var(--pulse-color,transparent);transform:translateZ(0)}40%{box-shadow:0 0 0 10px rgba(0,0,0,0);transform:scale(1.01)}100%{box-shadow:0 0 0 0 rgba(0,0,0,0);transform:none}}
  .pulse-c-accent{--pulse-color:rgba(37,99,235,.35)}
  .pulse-c-purple{--pulse-color:rgba(139,92,246,.45)}
  .pulse-c-indigo{--pulse-color:rgba(99,102,241,.45)}
  .pulse-c-sky{--pulse-color:rgba(56,189,248,.40)}
  .pulse-c-green{--pulse-color:rgba(34,197,94,.45)}
  .pulse-c-lime{--pulse-color:rgba(132,204,22,.45)}
  .pulse-c-yellow{--pulse-color:rgba(234,179,8,.45)}
  .pulse-c-orange{--pulse-color:rgba(249,115,22,.45)}
  .pulse-c-red{--pulse-color:rgba(244,63,94,.50)}
  .pulse-c-black{--pulse-color:rgba(17,24,39,.55)}
  .pulse-c-silver{--pulse-color:rgba(192,192,192,.65)}
  .pulse-c-gold{--pulse-color:rgba(212,175,55,.65)}
  .streak-badge{margin-left:8px;font-size:12px;line-height:1;padding:4px 8px;border-radius:999px;border:1px solid var(--sb-border,var(--ring));background:var(--sb-bg,#fff);color:var(--sb-fg,var(--ink));display:inline-flex;align-items:center;gap:6px;vertical-align:middle;box-shadow:0 1px 0 rgba(2,6,23,.06);backdrop-filter:saturate(120%) blur(2px);transition:background-color .2s ease,border-color .2s ease,color .2s ease}
  .streak-badge::before{content:"";width:8px;height:8px;border-radius:50%;background:var(--sb-color,var(--accent));box-shadow:0 0 0 2px rgba(255,255,255,.6) inset}
  .sb-purple{--sb-color:#8b5cf6;--sb-bg:rgba(139,92,246,.14);--sb-border:rgba(139,92,246,.38);--sb-fg:#0f172a}
  .sb-indigo{--sb-color:#6366f1;--sb-bg:rgba(99,102,241,.14);--sb-border:rgba(99,102,241,.38);--sb-fg:#0f172a}
  .sb-sky{--sb-color:#38bdf8;--sb-bg:rgba(56,189,248,.16);--sb-border:rgba(56,189,248,.45);--sb-fg:#0f172a}
  .sb-green{--sb-color:#22c55e;--sb-bg:rgba(34,197,94,.16);--sb-border:rgba(34,197,94,.45);--sb-fg:#0f172a}
  .sb-lime{--sb-color:#84cc16;--sb-bg:rgba(132,204,22,.18);--sb-border:rgba(132,204,22,.48);--sb-fg:#0f172a}
  .sb-yellow{--sb-color:#eab308;--sb-bg:rgba(234,179,8,.18);--sb-border:rgba(234,179,8,.55);--sb-fg:#0f172a}
  .sb-orange{--sb-color:#fb923c;--sb-bg:rgba(251,146,60,.18);--sb-border:rgba(251,146,60,.5);--sb-fg:#0f172a}
  .sb-red{--sb-color:#f43f5e;--sb-bg:rgba(244,63,94,.16);--sb-border:rgba(244,63,94,.5);--sb-fg:#0f172a}
  .sb-black{--sb-color:#111827;--sb-bg:rgba(17,24,39,.92);--sb-border:rgba(17,24,39,1);--sb-fg:#fff}
  .sb-silver{--sb-color:#9ca3af;--sb-bg:linear-gradient(180deg,rgba(229,231,235,.65),rgba(209,213,219,.35));--sb-border:rgba(156,163,175,.7);--sb-fg:#0f172a}
  .sb-gold{--sb-color:#b28a1a;--sb-bg:linear-gradient(180deg,rgba(250,204,21,.38),rgba(217,119,6,.22));--sb-border:rgba(178,138,26,.75);--sb-fg:#0f172a}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Adjektivdeklination Trainer</h1>
      <div class="subtitle">形容詞活用練習</div>
      <div class="row controls">
        <div class="seg" id="levelSeg" role="tablist" aria-label="level">
          <button data-level="All" class="active" aria-selected="true">ALL</button>
          <button data-level="A1+A2">A1+A2</button>
          <button data-level="B1">B1</button>
        </div>
        <div class="actions">
          <span class="hint-pill" id="preHint" hidden></span>
          <button class="btn tiny" id="preHintBtn">ヒント</button>
          <button class="btn" id="again">やり直す</button>
          <button class="btn primary" id="next">次の問題</button>
        </div>
      </div>
    </div>

    <div class="card" id="quiz">
      <div class="meta" id="tags"></div>
      <div class="question" id="q" aria-live="polite"></div>
      <div class="ja" id="q-ja"></div>
      <div class="choices" id="choices"></div>
      <div class="explain" id="exp" hidden></div>
      <div class="footer">
        <span class="stat" id="stat">0 問目 / 正答 0</span>
      </div>
    </div>

    <div class="card">
      <details class="ref" id="filterPanel">
        <summary>出題範囲（クリックで表示）</summary>
        <div class="row" style="gap:8px;align-items:flex-start;flex-wrap:wrap">
          <div style="min-width:220px">
            <div style="font-size:12px;color:#475569;margin-bottom:4px">格</div>
            <div class="checks" id="caseChecks">
              <label class="chk"><input type="checkbox" data-case="Nominativ" checked> <span>1格</span></label>
              <label class="chk"><input type="checkbox" data-case="Akkusativ" checked> <span>4格</span></label>
              <label class="chk"><input type="checkbox" data-case="Dativ" checked> <span>3格</span></label>
              <label class="chk"><input type="checkbox" data-case="Genitiv" checked> <span>2格</span></label>
            </div>
          </div>
          <div style="min-width:220px">
            <div style="font-size:12px;color:#475569;margin-bottom:4px">冠詞</div>
            <div class="checks" id="articleChecks">
              <label class="chk"><input type="checkbox" data-article="definite" checked> <span>定冠詞</span></label>
              <label class="chk"><input type="checkbox" data-article="indefinite" checked> <span>不定冠詞</span></label>
              <label class="chk"><input type="checkbox" data-article="none" checked> <span>無冠詞</span></label>
            </div>
          </div>
          <div style="min-width:220px">
            <div style="font-size:12px;color:#475569;margin-bottom:4px">性</div>
            <div class="checks" id="genderChecks">
              <label class="chk"><input type="checkbox" data-gender="masculine" checked> <span>男性名詞</span></label>
              <label class="chk"><input type="checkbox" data-gender="neuter" checked> <span>中性名詞</span></label>
              <label class="chk"><input type="checkbox" data-gender="feminine" checked> <span>女性名詞</span></label>
              <label class="chk"><input type="checkbox" data-gender="plural" checked> <span>複数形</span></label>
            </div>
          </div>
        </div>
      </details>
    </div>

    <div class="card">
      <details class="ref" id="refPanel">
        <summary>形容詞格変化 一覧表（クリックで表示）</summary>
        <div class="ref-tabs" role="tablist" aria-label="article-tabs">
          <button data-article="definite" class="active">定冠詞</button>
          <button data-article="indefinite">不定冠詞</button>
          <button data-article="none">無冠詞</button>
        </div>
        <div id="refControls" class="gender-tabs"></div>
        <div id="exampleView" class="example" hidden></div>
        <div id="refTableWrap"></div>
        <div class="ref-note">複数の不定は kein- や所有冠詞に準じる。</div>
      </details>
    </div>
  </div>

<script>
const ITEMS=[
  {"sentence":"der groß[[ADJ_END]] Hund","choices":["e","en","er"],"correct":"e","kase":"Nominativ","gender":"masculine","article":"definite","level":"A1","hintJP":"定冠詞＋男性名詞＋主格では形容詞は弱変化で『-e』","jp":"その大きな犬"},
  {"sentence":"die lecker[[ADJ_END]] Suppe","choices":["e","en","er"],"correct":"e","kase":"Nominativ","gender":"feminine","article":"definite","level":"A1","hintJP":"定冠詞＋女性名詞＋主格では『-e』","jp":"そのおいしいスープ"},
  {"sentence":"ein neu[[ADJ_END]] Auto","choices":["e","es","er"],"correct":"es","kase":"Nominativ","gender":"neuter","article":"indefinite","level":"A1","hintJP":"不定冠詞＋中性＋1格で『-es』","jp":"新しい車"},
  {"sentence":"das frisch[[ADJ_END]] Brot","choices":["e","en","es"],"correct":"e","kase":"Nominativ","gender":"neuter","article":"definite","level":"A1","hintJP":"定冠詞＋中性＋主格で『-e』","jp":"その新鮮なパン"},
  {"sentence":"die klein[[ADJ_END]] Kinder","choices":["en","e","er"],"correct":"en","kase":"Nominativ","gender":"plural","article":"definite","level":"A1","hintJP":"定冠詞の複数は全格『-en』","jp":"その小さな子どもたち"},
  {"sentence":"eine freundlich[[ADJ_END]] Lehrerin","choices":["e","en","er"],"correct":"e","kase":"Nominativ","gender":"feminine","article":"indefinite","level":"A1","hintJP":"不定冠詞＋女性＋主格で『-e』","jp":"ある親切な女の先生"},
  {"sentence":"einen heiß[[ADJ_END]] Kaffee","choices":["en","e","er"],"correct":"en","kase":"Akkusativ","gender":"masculine","article":"indefinite","level":"A2","hintJP":"前置詞なしの対格。不定＋男性＋4格で『-en』","jp":"熱いコーヒーを"},
  {"sentence":"den sauber[[ADJ_END]] Tisch","choices":["en","e","er"],"correct":"en","kase":"Akkusativ","gender":"masculine","article":"definite","level":"A2","hintJP":"定冠詞＋男性＋4格で『-en』","jp":"そのきれいなテーブルを"},
  {"sentence":"dem neu[[ADJ_END]] Lehrer","choices":["en","em","er"],"correct":"en","kase":"Dativ","gender":"masculine","article":"definite","level":"A2","hintJP":"定冠詞＋単数の3格は『-en』","jp":"その新しい先生に"},
  {"sentence":"der wichtig[[ADJ_END]] Frage","choices":["en","e","er"],"correct":"en","kase":"Dativ","gender":"feminine","article":"definite","level":"A2","hintJP":"定冠詞＋女性＋3格で『-en』","jp":"その大事な質問に"},
  {"sentence":"mit den nett[[ADJ_END]] Kollegen","choices":["en","e","er"],"correct":"en","kase":"Dativ","gender":"plural","article":"definite","level":"A2","hintJP":"mit は3格。定冠詞＋複数の3格は『-en』、名詞は通常 -n","jp":"親切な同僚たちと"},
  {"sentence":"eines groß[[ADJ_END]] Hauses","choices":["en","es","er"],"correct":"en","kase":"Genitiv","gender":"neuter","article":"indefinite","level":"A2","hintJP":"不定＋中性＋2格で『-en』","jp":"ある大きな家の"},
  {"sentence":"des alt[[ADJ_END]] Mannes","choices":["en","es","er"],"correct":"en","kase":"Genitiv","gender":"masculine","article":"definite","level":"A2","hintJP":"定冠詞＋男性＋2格は『-en』（名詞 -es/-s）","jp":"その年老いた男性の"},
  {"sentence":"ohne einen schwer[[ADJ_END]] Koffer","choices":["en","e","er"],"correct":"en","kase":"Akkusativ","gender":"masculine","article":"indefinite","level":"A2","hintJP":"ohne は常に4格。不定＋男性＋4格で『-en』","jp":"重いスーツケースなしで"},
  {"sentence":"schön[[ADJ_END]] Wetter","choices":["es","e","er"],"correct":"es","kase":"Nominativ","gender":"neuter","article":"none","level":"A2","hintJP":"無冠詞の強変化：中性の1・4格は『-es』","jp":"良い天気"},
  {"sentence":"alt[[ADJ_END]] Freunde","choices":["e","en","er"],"correct":"e","kase":"Nominativ","gender":"plural","article":"none","level":"A2","hintJP":"無冠詞の強変化：複数の1・4格は『-e』","jp":"古い友人たち"},
  {"sentence":"mit frisch[[ADJ_END]] Obst","choices":["em","en","er"],"correct":"em","kase":"Dativ","gender":"neuter","article":"none","level":"A2","hintJP":"mit は3格。無冠詞＋中性＋3格で『-em』","jp":"新鮮な果物と一緒に"},
  {"sentence":"wegen stark[[ADJ_END]] Regens","choices":["en","er","es"],"correct":"en","kase":"Genitiv","gender":"masculine","article":"none","level":"A2","hintJP":"wegen は2格。無冠詞＋男性＋2格で『-en』","jp":"強い雨のために"}
];
const MINI_TABLE={definite:{masculine:{Nominativ:"-e",Akkusativ:"-en",Dativ:"-en",Genitiv:"-en"},feminine:{Nominativ:"-e",Akkusativ:"-e",Dativ:"-en",Genitiv:"-en"},neuter:{Nominativ:"-e",Akkusativ:"-e",Dativ:"-en",Genitiv:"-en"},plural:{Nominativ:"-en",Akkusativ:"-en",Dativ:"-en",Genitiv:"-en"}},indefinite:{masculine:{Nominativ:"-er",Akkusativ:"-en",Dativ:"-en",Genitiv:"-en"},feminine:{Nominativ:"-e",Akkusativ:"-e",Dativ:"-en",Genitiv:"-en"},neuter:{Nominativ:"-es",Akkusativ:"-es",Dativ:"-en",Genitiv:"-en"},plural:{Nominativ:"-en",Akkusativ:"-en",Dativ:"-en",Genitiv:"-en"}},none:{masculine:{Nominativ:"-er",Akkusativ:"-en",Dativ:"-em",Genitiv:"-en"},feminine:{Nominativ:"-e",Akkusativ:"-e",Dativ:"-er",Genitiv:"-er"},neuter:{Nominativ:"-es",Akkusativ:"-es",Dativ:"-em",Genitiv:"-en"},plural:{Nominativ:"-e",Akkusativ:"-e",Dativ:"-en",Genitiv:"-er"}}};
const LABEL_JP={article:{definite:"定冠詞（類）",indefinite:"不定冠詞（類）",none:"冠詞なし"},gender:{masculine:"男性名詞",feminine:"女性名詞",neuter:"中性名詞",plural:"複数形"}};
const CASE_ORDER=["Nominativ","Akkusativ","Dativ","Genitiv"];
const GENDER_ORDER=["masculine","neuter","feminine","plural"];
const GENDER_JP_SHORT={masculine:"男性",feminine:"女性",neuter:"中性",plural:"複数"};
const ARTICLE_HEAD={definite:"定冠詞",indefinite:"不定冠詞",none:"無冠詞"};
const ARTICLE_DE={definite:"bestimmter Artikel",indefinite:"unbestimmter Artikel",none:"ohne Artikel"};
const GENDER_DE={masculine:"Maskulinum",feminine:"Femininum",neuter:"Neutrum",plural:"Plural"};
const CASE_DE={Nominativ:"Nominativ",Akkusativ:"Akkusativ",Dativ:"Dativ",Genitiv:"Genitiv"};
const CASE_ABBR={Nominativ:"Nom.",Akkusativ:"Akk.",Dativ:"Dat.",Genitiv:"Gen."};
const CASE_JP_NUM={Nominativ:"1格",Akkusativ:"4格",Dativ:"3格",Genitiv:"2格"};
const LEVEL_CASES={"All":["Nominativ","Akkusativ","Dativ","Genitiv"],"A1+A2":["Nominativ","Akkusativ","Dativ"],"B1":["Genitiv"]};
let state={level:"All",pool:[],order:[],idx:0,correct:0,total:0,streak:0,filters:{cases:{Nominativ:true,Akkusativ:true,Dativ:true,Genitiv:true},articles:{definite:true,indefinite:true,none:true},genders:{masculine:true,neuter:true,feminine:true,plural:true}}};
let currentArticle='definite';
let currentGender='masculine';
let EX_GLOBAL=null;
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
function replaceAllSafe(str,find,rep){return str.split(find).join(rep)}
function validateItem(it){const ok=it&&typeof it.sentence==="string"&&it.sentence.includes("[[ADJ_END]]")&&Array.isArray(it.choices)&&it.choices.length===3&&new Set(it.choices).size===3&&typeof it.correct==="string"&&it.choices.includes(it.correct)&&it.kase&&it.gender&&it.article&&it.jp;return ok?it:{sentence:"Ein [[ADJ_END]] Buch.",choices:["e","es","er"],correct:"es",kase:"Nominativ",gender:"neuter",article:"indefinite",jp:"新しい本"}}
function buildPool(){const allowed=LEVEL_CASES[state.level]||CASE_ORDER;let pool=ITEMS.map(validateItem).filter(it=>allowed.includes(it.kase));pool=pool.filter(it=>state.filters.cases[it.kase]&&state.filters.articles[it.article]&&state.filters.genders[it.gender]);if(pool.length===0){state.filters={cases:{Nominativ:true,Akkusativ:true,Dativ:true,Genitiv:true},articles:{definite:true,indefinite:true,none:true},genders:{masculine:true,neuter:true,feminine:true,plural:true}};pool=ITEMS.map(validateItem).filter(it=>allowed.includes(it.kase))}state.pool=pool;state.order=shuffle([...Array(pool.length).keys()]);state.idx=0;state.total=0;state.correct=0;state.streak=0}
function showError(txt){const qEl=document.getElementById('q');const jaEl=document.getElementById('q-ja');const chEl=document.getElementById('choices');const expEl=document.getElementById('exp');if(qEl)qEl.innerHTML=`<span style="color:#b91c1c">⚠ ${txt}</span>`;if(jaEl)jaEl.textContent='';if(chEl)chEl.innerHTML='';if(expEl){expEl.hidden=true;expEl.innerHTML=''}}
function extractStem(sentence){const k=sentence.indexOf('[[ADJ_END]]');const before=sentence.slice(0,k);const lastSpace=Math.max(before.lastIndexOf(' '),before.lastIndexOf('\n'));return before.slice(lastSpace+1)}
function render(){try{if(state.idx>=state.order.length){buildPool()}if(!state.pool||!state.pool.length){showError('出題範囲に一致する問題がありません。上の「出題範囲」を確認してください。');updateStat();return}const ord=state.order[state.idx];if(typeof ord==='undefined'){showError('内部エラー：問題の読み込みに失敗しました。');return}const it=state.pool[ord];if(!it){showError('内部エラー：問題データが見つかりません。');return}const qEl=document.getElementById('q');const jaEl=document.getElementById('q-ja');const chEl=document.getElementById('choices');const expEl=document.getElementById('exp');expEl.hidden=true;expEl.innerHTML='';const stem=extractStem(it.sentence);let shown=replaceAllSafe(it.sentence,'[[ADJ_END]]','<span class="blank">____</span>');const marker=stem+"<span class=\"blank\">____</span>";if(shown.indexOf(marker)>-1){shown=shown.replace(marker,'<span class="blank">＿＿＿</span>')}qEl.innerHTML=shown;if(!qEl.textContent||qEl.textContent.trim()===''){const fb=(it.sentence||'').replace('[[ADJ_END]]','____');qEl.textContent=fb||'（問題文の描画に失敗しました）'}jaEl.textContent=it.jp||'';const preHintBtn=document.getElementById('preHintBtn');const preHint=document.getElementById('preHint');if(preHint){preHint.hidden=true;preHint.style.display='none';preHint.textContent=`${ARTICLE_HEAD[it.article]}・${GENDER_JP_SHORT[it.gender]}・${CASE_JP_NUM[it.kase]}`}if(preHintBtn){preHintBtn.disabled=false;preHintBtn.onclick=()=>{if(preHint){preHint.hidden=false;preHint.style.display='inline-block'}preHintBtn.disabled=true}}const opts=shuffle(it.choices.map(end=>({end,full:(stem+end)})));chEl.innerHTML='';opts.forEach(o=>{const b=document.createElement('button');b.textContent=o.full;b.addEventListener('click',()=>grade(it,o,stem));chEl.appendChild(b)});document.getElementById('next').onclick=()=>{state.idx++;state.total++;render();updateStat();fitChoiceText();scaleChoices()};document.getElementById('again').onclick=()=>{render();fitChoiceText();scaleChoices()};updateStat();fitChoiceText();requestAnimationFrame(scaleChoices)}catch(err){console.error(err);showError('実行時エラー：'+(err&&err.message?err.message:'原因不明'))}}
function updateStat(){document.getElementById('stat').textContent=`${state.total} 問目 / 正答 ${state.correct}`}
function colorKeyForStreak(s){if(s>=30)return'gold';if(s>=20)return'silver';if(s>=10)return'black';if(s>=9)return'red';if(s>=8)return'orange';if(s>=7)return'yellow';if(s>=6)return'lime';if(s>=5)return'green';if(s>=4)return'sky';if(s>=3)return'indigo';if(s>=2)return'purple';return'accent'}
const STREAK_BADGES={2:'Toll! すてき！',3:'Super! すごい！',4:'Spitze! 最高！',5:'Genial! 天才的だ！',7:'Unglaublich! 信じられない！',10:'Wahnsinn! 半端ない！',20:'Unfassbar! 理解を超える！',30:'Der absolute Hammer! 究極にすごい！'};
function buildStreakBadge(s){const msg=STREAK_BADGES[s];if(!msg)return'';const key=colorKeyForStreak(s);return `<span class="streak-badge sb-${key}" title="${s}連続正解">${msg}</span>`}
function triggerPulse(streak){const card=document.getElementById('quiz');if(!card)return;const all=['pulse-c-accent','pulse-c-purple','pulse-c-indigo','pulse-c-sky','pulse-c-green','pulse-c-lime','pulse-c-yellow','pulse-c-orange','pulse-c-red','pulse-c-black','pulse-c-silver','pulse-c-gold'];card.classList.remove('pulse',...all);const key='pulse-c-'+colorKeyForStreak(streak);void card.offsetWidth;card.classList.add('pulse',key);clearTimeout(card._pulseTimer);card._pulseTimer=setTimeout(()=>{card.classList.remove('pulse',key)},900)}
function buildRightCaseList(tbl){if(!tbl)return'';const rows=CASE_ORDER.map(cs=>({jp:CASE_JP_NUM[cs],end:tbl[cs]}));return `<div class="caseList">${rows.map(r=>`<div class="case"><div class="label">${r.jp}</div><div class="ending">${r.end}</div></div>`).join('')}</div>`}
function endClassFrom(end){const e=end.replace('-','');return['e','en','em','er','es'].includes(e)?e:'e'}
function buildGermanHint(it){const end=it.correct.startsWith('-')?it.correct:'-'+it.correct;return `${ARTICLE_DE[it.article]} + ${GENDER_DE[it.gender]} + ${CASE_DE[it.kase]} → Adjektivendung ${end}.`}
function buildFootnotes(it){const notes=[];if(it.kase==='Dativ'&&it.gender==='plural')notes.push('※ 複数与格は名詞に -n（すでに -n/-s なら不要）');if(it.kase==='Genitiv'&&(it.gender==='masculine'||it.gender==='neuter'))notes.push('※ 男性・中性の単数属格は名詞に -s/-es');return notes.length?`<div class="footnotes">${notes.join('<br>')}</div>`:''}
function grade(it,picked,stem){const buttons=Array.from(document.getElementById('choices').children);buttons.forEach(btn=>btn.disabled=true);const correctEnd=it.correct;const isCorrect=picked.end===correctEnd;buttons.forEach(btn=>{const end=btn.textContent.slice(stem.length);if(end===correctEnd)btn.classList.add('correct');if(btn.textContent===(stem+picked.end))btn.classList.add(isCorrect?'correct':'wrong')});if(isCorrect){state.streak=(state.streak||0)+1;triggerPulse(state.streak);state.correct++}else{state.streak=0}const exp=document.getElementById('exp');const tbl=MINI_TABLE[it.article]?.[it.gender]||null;const solved=it.sentence.replace('[[ADJ_END]]',it.correct);const streakHtml=isCorrect?buildStreakBadge(state.streak):'';const mark=isCorrect?`<span class="badge good">✔ 正解</span>${streakHtml}`:`<span class="badge bad">✘ 不正解</span>`;const isMixedPoint=it.article==='indefinite';const declKind=it.article==='definite'?'weak':(it.article==='indefinite'?'mixed':'strong');const declLabel=declKind==='weak'?'弱変化':(declKind==='mixed'?'混合変化':'強変化');const declCls=declKind;let hintJPText=(it.hintJP||'').replace('主・対格','1・4格').replace('主・4格','1・4格').replace('主格（混合）','1格').replace('主格','1格').replace('対格','4格').replace('与格','3格').replace('属格','2格').replace('（混合）','').replace('』。','』');if(it.article==='definite'&&it.gender==='plural')hintJPText='定冠詞の複数は全ての格で『-en』';if((it.sentence&&it.sentence.includes('ohne'))||(it.hintJP&&it.hintJP.includes('ohne'))){const bare=it.correct.startsWith('-')?it.correct.slice(1):it.correct;const tail=it.article==='indefinite'?` 不定冠詞＋${GENDER_JP_SHORT[it.gender]}＋${CASE_JP_NUM[it.kase]} ⇒ 形容詞は『-${bare}』`:'';hintJPText='前置詞「ohne」は常に4格（Akkusativ）を支配する。'+tail}const btnsHtml=`
    <div class="de-line">
      <span class="de">${buildGermanHint(it)}</span>
      ${isMixedPoint?'<button class="btn tiny" id="mixBtn">混合変化とは</button>':''}
      ${it.article==='definite'?'<button class="btn tiny" id="weakBtn">弱変化とは</button>':''}
      ${it.article==='none'?'<button class="btn tiny" id="strongBtn">強変化とは</button>':''}
    </div>`;const rightHtml=`
    <aside class="right">
      <h3>${ARTICLE_HEAD[it.article]}・${GENDER_JP_SHORT[it.gender]}</h3>
      <div class="sub-de">${ARTICLE_DE[it.article]} ・<br>${GENDER_DE[it.gender]}</div>
      ${buildRightCaseList(tbl)||'<p>（参照表なし）</p>'}
    </aside>`;const mixInit=isMixedPoint?`<div id="mixBox" class="example mix-wide" hidden><h3 class="mix-title">形容詞の混合変化</h3><div class="mix-subtitle">(Gemischte Deklination)</div><p>不定冠詞（類）を伴う名詞に形容詞が加わると、形容詞は混合変化と呼ばれる語尾変化をします。</p><p><strong>混合変化と呼ばれる理由</strong><br>その名の通り、強変化と弱変化の混合形態です。不定冠詞（類）の格変化が明確な場合は形容詞の語尾変化は少なく、逆に不定冠詞（類）だけでは名詞の性や格を明らかにできない場合は（特に男性と中性の1格）、形容詞の語尾が強変化することで格変化の補完をします。</p></div>`:'';const weakInit=it.article==='definite'?`<div id="weakBox" class="example mix-wide" hidden><h3 class="mix-title">形容詞の弱変化</h3><div class="mix-subtitle">(Schwache Deklination)</div><p>定冠詞（der, die, das）やder類（dieser, jeder, welcher, solcher, mancher など）の後に続く形容詞の語尾変化ルールです。</p><p><strong>弱変化と呼ばれる理由</strong><br>先行する冠詞が格・性・数を完全に示すため、形容詞は語尾での区別を最小限にとどめます（原則 -en、単数主格と女性・中性の対格のみ -e）。そのため「弱い」変化と呼ばれます。</p></div>`:'';const strongInit=it.article==='none'?`<div id="strongBox" class="example mix-wide" hidden><h3 class="mix-title">形容詞の強変化</h3><div class="mix-subtitle">(Starke Deklination)</div><p>冠詞類を用いない名詞に形容詞が加わると、形容詞は強変化と呼ばれる語尾変化をします。</p><p><strong>強変化と呼ばれる理由</strong><br>形容詞が語尾変化をすることで冠詞類の格変化の代わりをし、語尾変化が顕著であることから強変化と呼ばれます。</p></div>`:'';exp.innerHTML=`
    <div class="result-full">
      <h3>正解・和訳</h3>
      <p class="result-line">${mark}<span></span></p>
      <p>正しい文：<strong>${solved}</strong></p>
      <p>和訳：${it.jp}</p>
    </div>
    <div class="cols">
      <div class="left" style="min-width:0">
        <h3>解説 <span class="decl-tag ${declCls}">${declLabel}</span></h3>
        <p>${hintJPText}</p>
        ${btnsHtml}
      </div>
      ${rightHtml}
      ${weakInit}${strongInit}${mixInit}
    </div>`;exp.hidden=false;const nhtml=buildFootnotes(it);if(nhtml){const tmp=document.createElement('div');tmp.innerHTML=nhtml;const node=tmp.firstElementChild;if(node)exp.appendChild(node)}const expBox=document.getElementById('exp');function ensureBox(id,html){let el=document.getElementById(id);if(!el){el=document.createElement('div');el.id=id;el.className='example mix-wide';el.hidden=true;el.innerHTML=html;const cols=expBox.querySelector('.cols');if(cols)cols.appendChild(el)}return el}const mixBtn=document.getElementById('mixBtn');if(mixBtn){mixBtn.onclick=()=>{const bx=ensureBox('mixBox','<h3 class="mix-title">形容詞の混合変化</h3><div class="mix-subtitle">(Gemischte Deklination)</div><p>不定冠詞（類）を伴う名詞に形容詞が加わると、形容詞は混合変化と呼ばれる語尾変化をします。</p><p><strong>混合変化と呼ばれる理由</strong><br>その名の通り、強変化と弱変化の混合形態です。不定冠詞（類）の格変化が明確な場合は形容詞の語尾変化は少なく、逆に不定冠詞（類）だけでは名詞の性や格を明らかにできない場合は（特に男性と中性の1格）、形容詞の語尾が強変化することで格変化の補完をします。</p>');if(bx)bx.hidden=!bx.hidden}}const weakBtn=document.getElementById('weakBtn');if(weakBtn){weakBtn.onclick=()=>{const wx=ensureBox('weakBox','<h3 class="mix-title">形容詞の弱変化</h3><div class="mix-subtitle">(Schwache Deklination)</div><p>定冠詞（der, die, das）やder類（dieser, jeder, welcher, solcher, mancher など）の後に続く形容詞の語尾変化ルールです。</p><p><strong>弱変化と呼ばれる理由</strong><br>先行する冠詞が格・性・数を完全に示すため、形容詞は語尾での区別を最小限にとどめます（原則 -en、単数主格と女性・中性の対格のみ -e）。そのため「弱い」変化と呼ばれます。</p>');if(wx)wx.hidden=!wx.hidden}}const strongBtn=document.getElementById('strongBtn');if(strongBtn){strongBtn.onclick=()=>{const sx=ensureBox('strongBox','<h3 class="mix-title">形容詞の強変化</h3><div class="mix-subtitle">(Starke Deklination)</div><p>冠詞類を用いない名詞に形容詞が加わると、形容詞は強変化と呼ばれる語尾変化をします。</p><p><strong>強変化と呼ばれる理由</strong><br>形容詞が語尾変化をすることで冠詞類の格変化の代わりをし、語尾変化が顕著であることから強変化と呼ばれます。</p>');if(sx)sx.hidden=!sx.hidden}}currentArticle=it.article;currentGender=it.gender;mountRef(currentArticle)}
const DETERMINER={definite:{masculine:{Nominativ:'der',Akkusativ:'den',Dativ:'dem',Genitiv:'des'},neuter:{Nominativ:'das',Akkusativ:'das',Dativ:'dem',Genitiv:'des'},feminine:{Nominativ:'die',Akkusativ:'die',Dativ:'der',Genitiv:'der'},plural:{Nominativ:'die',Akkusativ:'die',Dativ:'den',Genitiv:'der'}},indefinite:{masculine:{Nominativ:'ein',Akkusativ:'einen',Dativ:'einem',Genitiv:'eines'},neuter:{Nominativ:'ein',Akkusativ:'ein',Dativ:'einem',Genitiv:'eines'},feminine:{Nominativ:'eine',Akkusativ:'eine',Dativ:'einer',Genitiv:'einer'},plural:{Nominativ:'meine',Akkusativ:'meine',Dativ:'meinen',Genitiv:'meiner'}},none:{masculine:{Nominativ:'',Akkusativ:'',Dativ:'',Genitiv:''},neuter:{Nominativ:'',Akkusativ:'',Dativ:'',Genitiv:''},feminine:{Nominativ:'',Akkusativ:'',Dativ:'',Genitiv:''},plural:{Nominativ:'',Akkusativ:'',Dativ:'',Genitiv:''}}};
const EXAMPLE_NOUNS={default:{masculine:{base:'Wein',gen:'Weins'},neuter:{base:'Brot',gen:'Brotes'},feminine:{base:'Milch',gen:'Milch'},plural:{base:'Freunde',datpl:'Freunden',genpl:'Freunde'}},indefinite:{masculine:{base:'Vater',gen:'Vaters'},neuter:{base:'Kind',gen:'Kindes'},feminine:{base:'Mutter',gen:'Mutter'},plural:{base:'Freunde',datpl:'Freunden',genpl:'Freunde'}}};
const ADJ_STEM='gut';
function computeGlobalExampleLayout(){try{const measure=document.createElement('div');measure.style.cssText='position:absolute;visibility:hidden;left:-9999px;top:-9999px';document.body.appendChild(measure);const artKeys=['definite','indefinite','none'];const genders=['masculine','neuter','feminine','plural'];const cases=['Nominativ','Akkusativ','Dativ','Genitiv'];let maxDet=0,maxAdj=0,maxTable=0,maxTablePlural=0;function makeCell(article,gender,kase){const line=buildExampleLine(article,gender,kase);const wrap=document.createElement('div');wrap.className='ex-cell';wrap.innerHTML=line.text;return wrap}artKeys.forEach(a=>{genders.forEach(g=>{cases.forEach(k=>{const cell=makeCell(a,g,k);measure.appendChild(cell);const det=cell.querySelector('.ex-det');const adj=cell.querySelector('.ex-adj');const wDet=det?det.getBoundingClientRect().width:0;const wAdj=adj?adj.getBoundingClientRect().width:0;if(wDet>maxDet)maxDet=wDet;if(wAdj>maxAdj)maxAdj=wAdj;measure.removeChild(cell)})})});const abbrs=['Kasus','Nom.','Akk.','Dat.','Gen.'];let maxCaseCol=0;abbrs.forEach(txt=>{const t=document.createElement('table');t.className='ex-table';const tr=document.createElement('tr');const td1=document.createElement('td');td1.textContent=txt;tr.appendChild(td1);const td2=document.createElement('td');td2.textContent='X';tr.appendChild(td2);t.appendChild(tr);measure.appendChild(t);const w=td1.getBoundingClientRect().width;if(w>maxCaseCol)maxCaseCol=w;measure.removeChild(t)});function makeTable(article,gender){const table=document.createElement('table');table.className='ex-table';const thead=document.createElement('thead');thead.innerHTML='<tr><th>Kasus</th><th>Beispiel</th></tr>';table.appendChild(thead);const tbody=document.createElement('tbody');cases.forEach(k=>{const tr=document.createElement('tr');const td1=document.createElement('td');td1.textContent={Nominativ:'Nom.',Akkusativ:'Akk.',Dativ:'Dat.',Genitiv:'Gen.'}[k];tr.appendChild(td1);const td2=document.createElement('td');td2.className='ex-cell';const inner=makeCell(article,gender,k);td2.appendChild(inner);tr.appendChild(td2);tbody.appendChild(tr)});table.appendChild(tbody);return table}artKeys.forEach(a=>{genders.forEach(g=>{const t=makeTable(a,g);measure.appendChild(t);const w=t.getBoundingClientRect().width;if(w>maxTable)maxTable=w;if(g==='plural'&&w>maxTablePlural)maxTablePlural=w;measure.removeChild(t)})});EX_GLOBAL={det:Math.ceil(maxDet),adj:Math.ceil(maxAdj),table:Math.ceil(maxTablePlural||maxTable),caseCol:Math.ceil(maxCaseCol)};const ev=document.getElementById('exampleView');if(ev){ev.style.setProperty('--det-w',EX_GLOBAL.det+'px');ev.style.setProperty('--adj-w',EX_GLOBAL.adj+'px');ev.style.minWidth=(EX_GLOBAL.table+16)+'px';const tEl=ev.querySelector('table.ex-table');if(tEl){tEl.style.width=(EX_GLOBAL.table+16)+'px'}}document.body.removeChild(measure)}catch(_e){}}
function buildExampleLine(article,gender,kase){const end=MINI_TABLE[article][gender][kase];const cls=endClassFrom(end);const adj=ADJ_STEM+`<span class="end ${cls}">${end.replace('-','')}</span>`;const set=(article==='indefinite')?EXAMPLE_NOUNS.indefinite:EXAMPLE_NOUNS.default;let det='';if(article==='definite')det=DETERMINER.definite[gender][kase];else if(article==='indefinite')det=DETERMINER.indefinite[gender][kase];const n=set[gender];let noun='';if(gender==='plural'){noun=(kase==='Dativ')?n.datpl:(kase==='Genitiv'?n.genpl:n.base)}else if(gender==='masculine'||gender==='neuter'){noun=(kase==='Genitiv')?n.gen:n.base}else{noun=n.base}return{kase,text:`<div class="ex-row"><span class="ex-det">${det||''}</span><span class="ex-adj">${adj}</span><span class="ex-noun">${noun||''}</span></div>`}}
function alignExampleColumns(){const ev=document.getElementById('exampleView');if(!ev)return;if(EX_GLOBAL){ev.style.setProperty('--det-w',EX_GLOBAL.det+'px');ev.style.setProperty('--adj-w',EX_GLOBAL.adj+'px');ev.style.minWidth=(EX_GLOBAL.table+16)+'px'}}
function showExamples(article,gender){const ev=document.getElementById('exampleView');const head=`${LABEL_JP.gender[gender]}（${LABEL_JP.article[article]}＋形容詞＋名詞）`;const rows=CASE_ORDER.map(cs=>{const line=buildExampleLine(article,gender,cs);const left=CASE_ABBR[line.kase];const right=line.text;return `<tr><td>${left}</td><td class="ex-cell">${right}</td></tr>`}).join('');const caseWidth=(EX_GLOBAL&&EX_GLOBAL.caseCol)?EX_GLOBAL.caseCol:72;ev.innerHTML=`<h4>${head}</h4><table class="ex-table"><colgroup><col style="width:${caseWidth}px"><col></colgroup><thead><tr><th>Kasus</th><th>Beispiel</th></tr></thead><tbody>${rows}</tbody></table>`;const tEl=ev.querySelector('table.ex-table');if(tEl){tEl.style.width=(EX_GLOBAL&&EX_GLOBAL.table?(EX_GLOBAL.table+16):(ev.offsetWidth||320))+'px'}ev.hidden=false;requestAnimationFrame(()=>{computeGlobalExampleLayout();alignExampleColumns()})}
function buildReferenceTable(articleKey){const t=MINI_TABLE[articleKey];const table=document.createElement('table');table.className='ref-table';const thead=document.createElement('thead');const trh=document.createElement('tr');trh.innerHTML=`<th></th>${GENDER_ORDER.map(g=>`<th>${GENDER_JP_SHORT[g]}</th>`).join('')}`;thead.appendChild(trh);table.appendChild(thead);const tbody=document.createElement('tbody');CASE_ORDER.forEach(cs=>{const tr=document.createElement('tr');const tds=GENDER_ORDER.map(g=>{const val=t[g][cs];const cls=(val==='-en'&&(articleKey==='definite'||articleKey==='indefinite'))?' class="en-bg"':'';return `<td${cls}>${val}</td>`}).join('');tr.innerHTML=`<td><strong>${CASE_JP_NUM[cs]}</strong></td>`+tds;tbody.appendChild(tr)});table.appendChild(tbody);return table}
function applyGenderHighlight(){const wrap=document.getElementById('refTableWrap');const tbl=wrap&&wrap.querySelector('table.ref-table');if(!tbl)return;tbl.classList.remove('hl-masculine','hl-neuter','hl-feminine','hl-plural');tbl.classList.add('hl-'+currentGender);const headRow=tbl.querySelector('thead tr');if(!headRow)return;const ths=headRow.querySelectorAll('th');ths.forEach(th=>th.classList.remove('flash'));const idxMap={masculine:1,neuter:2,feminine:3,plural:4};const targetTh=ths[idxMap[currentGender]];if(targetTh){void targetTh.offsetWidth;targetTh.classList.add('flash')}const rows=tbl.querySelectorAll('tbody tr');rows.forEach(tr=>{const tds=tr.querySelectorAll('td');tds.forEach(td=>td.classList.remove('flash'));const td=tds[idxMap[currentGender]];if(td){void td.offsetWidth;td.classList.add('flash')}})}
function mountRef(articleKey='definite'){currentArticle=articleKey;const tabs=document.querySelectorAll('.ref-tabs button');tabs.forEach(b=>b.classList.toggle('active',b.dataset.article===articleKey));const wrap=document.getElementById('refTableWrap');wrap.innerHTML='';const controls=document.getElementById('refControls');controls.innerHTML='';const genders=[{key:'masculine',label:'男性名詞'},{key:'neuter',label:'中性名詞'},{key:'feminine',label:'女性名詞'},{key:'plural',label:'複数形'}];genders.forEach(g=>{const b=document.createElement('button');b.textContent=g.label;b.dataset.gender=g.key;if(g.key===currentGender)b.classList.add('active');b.onclick=()=>{currentGender=g.key;controls.querySelectorAll('button').forEach(x=>x.classList.remove('active'));b.classList.add('active');showExamples(articleKey,currentGender);applyGenderHighlight()};controls.appendChild(b)});showExamples(articleKey,currentGender);wrap.appendChild(buildReferenceTable(articleKey));applyGenderHighlight()}
function bindRefTabs(){const tabs=document.querySelectorAll('.ref-tabs button');tabs.forEach(btn=>btn.addEventListener('click',()=>{tabs.forEach(b=>b.classList.remove('active'));btn.classList.add('active');mountRef(btn.dataset.article)}))}
function bindSeg(id,key){const seg=document.getElementById(id);seg.querySelectorAll('button').forEach(btn=>{btn.addEventListener('click',()=>{seg.querySelectorAll('button').forEach(b=>b.classList.remove('active'));btn.classList.add('active');state[key]=btn.dataset[key];if(key==='level'){buildPool()}render()})})}
function initFilterPills(){const caseBox=document.getElementById('caseChecks');const artBox=document.getElementById('articleChecks');const genBox=document.getElementById('genderChecks');function readAndApply(){let selectedCount=0;caseBox.querySelectorAll('input[type="checkbox"]').forEach(inp=>{state.filters.cases[inp.dataset.case]=inp.checked;if(inp.checked)selectedCount++});artBox.querySelectorAll('input[type="checkbox"]').forEach(inp=>{state.filters.articles[inp.dataset.article]=inp.checked;if(inp.checked)selectedCount++});genBox.querySelectorAll('input[type="checkbox"]').forEach(inp=>{state.filters.genders[inp.dataset.gender]=inp.checked;if(inp.checked)selectedCount++});if(selectedCount===0){caseBox.querySelectorAll('input').forEach(inp=>inp.checked=true);artBox.querySelectorAll('input').forEach(inp=>inp.checked=true);genBox.querySelectorAll('input').forEach(inp=>inp.checked=true);state.filters.cases={Nominativ:true,Akkusativ:true,Dativ:true,Genitiv:true};state.filters.articles={definite:true,indefinite:true,none:true};state.filters.genders={masculine:true,neuter:true,feminine:true,plural:true}}buildPool();render()}[caseBox,artBox,genBox].forEach(box=>{box.querySelectorAll('input[type="checkbox"]').forEach(inp=>inp.addEventListener('change',readAndApply))})}
function scaleChoices(){const ch=document.getElementById('choices');if(!ch)return;ch.style.transform='none';const avail=ch.clientWidth;let full=0;Array.from(ch.children).forEach((el,i)=>{full+=el.offsetWidth;if(i>0)full+=10});const scale=full>0?Math.min(1,avail/full):1;ch.style.transformOrigin='left center';ch.style.transform=`scale(${scale})`}
function fitChoiceText(){const btns=document.querySelectorAll('#choices button');btns.forEach(b=>{let fs=18;b.style.fontSize=fs+'px';const limit=Math.max(10,Math.min(18,Math.floor(b.clientWidth/10)));let guard=12;while(guard-->0&&b.scrollWidth>b.clientWidth){fs-=1;if(fs<limit)break;b.style.fontSize=fs+'px'}})}
function start(){try{buildPool();render();computeGlobalExampleLayout();bindSeg('levelSeg','level');bindRefTabs();initFilterPills();mountRef('definite');if(document.fonts&&document.fonts.ready){document.fonts.ready.then(()=>{computeGlobalExampleLayout();mountRef(currentArticle||'definite');alignExampleColumns()})}const refPanelEl=document.getElementById('refPanel');if(refPanelEl){refPanelEl.addEventListener('toggle',()=>{if(refPanelEl.open)requestAnimationFrame(()=>{alignExampleColumns()})})}window.addEventListener('resize',()=>{fitChoiceText();scaleChoices();computeGlobalExampleLayout();alignExampleColumns()});setTimeout(()=>{const q=document.getElementById('q');if(q&&(!q.textContent||q.textContent.includes('読み込み中'))){render()}},200);setTimeout(()=>{const q=document.getElementById('q');if(q&&(!q.textContent||q.textContent.includes('読み込み中'))){const it=(state.pool&&state.pool[state.order[0]])||ITEMS[0];if(it){q.textContent=(it.sentence||'').replace('[[ADJ_END]]','____')}}},600)}catch(e){showError('初期化エラー：'+(e&&e.message?e.message:e))}}
if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',start,{once:true})}else{start()}
</script>
</body>
</html>
